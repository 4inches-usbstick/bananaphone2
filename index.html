<style>
body{
font-family: "Segoe UI", sans-serif;
background-color: #222;
}

button,select,input {
font-family: "SimHei", sans-serif;
background-color: #555;
color: white;
}

button {
border: 1px solid none;
}

button:hover,input:hover,select:hover {
border: 2px solid yellow;
}

p,b {
color: white;
}

.display {
color: white;
display: inline;
}

b {
font-size: 24px;
}






</style>


<div id='beforeconnect'>
<div id='connection' style='border: 1px solid none'>
<b style='font-variant: small-caps'>Connection details</b><br>

<p class='display'>endpoint</p> <input id='url' value='wss://cbe.fr.to:8888'> <p class='display'>(complete WebSockets url)</p><br>
<p class='display'>channel&nbsp;&nbsp;&nbsp;</p>
<select id="val1"><option value="0">0</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option><option value="9">9</option><option value="A">A</option><option value="B">B</option><option value="C">C</option><option value="D">D</option><option value="E">E</option><option value="F">F</option></select>
<select id="val2"><option value="0">0</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option><option value="9">9</option><option value="A">A</option><option value="B">B</option><option value="C">C</option><option value="D">D</option><option value="E">E</option><option value="F">F</option></select>
<select id="val3"><option value="0">0</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option><option value="9">9</option><option value="A">A</option><option value="B">B</option><option value="C">C</option><option value="D">D</option><option value="E">E</option><option value="F">F</option></select>
<select id="val4"><option value="0">0</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option><option value="9">9</option><option value="A">A</option><option value="B">B</option><option value="C">C</option><option value="D">D</option><option value="E">E</option><option value="F">F</option></select>
</select>


<br><br> <button onclick='gosocket()'>Attempt to connect</button>
<p id='preport' style='display:inline;'> </p>
	<p class='display'>deployment on 1 Jan 22</p>
</div>
</div>

<br>


<div id='afterconnect' hidden>
<p id='notification' style='background-color: #333'></p>

<p class='display'>You are now in a call. Channel: <p id='channel' class='display' style='font-style: oblique;'>undefined</p><br></p>

<p class="display">Mute <input id='mute' type='checkbox'>&nbsp;</p>
<p class="display">Deaf <input id='deaf' type='checkbox'><br></p>

<br>
<button style='background-color: red;' onclick='window.userinitiated = true; window.socket.send("DN"+getchannel()+"null");'>Close WebSocket connection</button>
<p class='display'>(please remember to disconnect the WebSocket connection before closing the page)</p><br><br>
<button href='javascript:void(0)' onclick='document.getElementById("audio").style.display = "block"'>Show audio settings</button>
<button href='javascript:void(0)' onclick='document.getElementById("audio").style.display = "none"'>Hide audio settings</button>


<div id='audio'  hidden>
<b style='font-variant: small-caps'>Audio input</b><br>
<p id='inputs' style='display:inline;'>
Javascript is loading your available mic inputs...
</p><br><br>
<p class="display">Pick your input:</p> <input style='width: 35px;' id='aids' value='0'><br><br><br>

<b style='font-variant: small-caps'>Packet interval</b><br>
<input id='interval' style='width: 65px;' value='420'> <p class="display">(time in ms)</p>
<br><br>

<b style='font-variant: small-caps'>Output volume</b><br>
<input id='vol' style='width: 65px;' value='1.0'> <p class="display">(must be a floating point number from 0.0 to 1.0)</p>
<br><br>

</div>

</div>




<script id='networkoperations'>
// fill in the slot
const urlParams = new URLSearchParams(window.location.search);
var predef = urlParams.get('channel')

if (predef == null) {
var predef = 'ok';
}

if (predef.length == 4) {
document.getElementById('val1').value = predef.slice(0,1)
document.getElementById('val2').value = predef.slice(1,2)
document.getElementById('val3').value = predef.slice(2,3)
document.getElementById('val4').value = predef.slice(3,4)
}
// get all inputs
navigator.mediaDevices.enumerateDevices().then((devices) => {
to = ""
window.aiid = devices;
 for (var i=0; i<devices.length; i++) {
 if (devices[i].kind == 'audioinput') {
 to = to + i + ' ' + devices[i].label + '<br>'
 }}
 
document.getElementById('inputs').innerHTML = to;
})


// Create WebSocket connection.
function getchannel() {
return document.getElementById('val1').value+document.getElementById('val2').value+document.getElementById('val3').value+document.getElementById('val4').value
}

function gosocket() {
window.userinitiated = false;
document.getElementById('preport').innerHTML = 'Connecting...'
window.socket = new WebSocket(document.getElementById('url').value);


// Connection opened
window.socket.addEventListener('open', function (event) {
	document.getElementById('beforeconnect').style.display = 'none'
	document.getElementById('afterconnect').style.display = 'block'
	document.getElementById('channel').innerHTML = getchannel()
    socket.send('CN'+getchannel());
	transmitpacket();
	
});

// Listen for messages
window.socket.addEventListener('message', function (event) {
    console.log('Message from server:', event.data);
	if (event.data.slice(0,2) == 'RL') {
	playSound(event.data.slice(6));
	}
	if (event.data.slice(0,2) == 'NU') {
	var a = new Audio('4beep.mp3');
a.play()
document.getElementById('notification').innerHTML = 'A new user has joined: '+event.data.slice(2)
	}
	if (event.data.slice(0,2) == 'DU') {
	var a = new Audio('fourbeeperror.mp3');
a.play()
document.getElementById('notification').innerHTML = 'Someone has disconnected: '+event.data.slice(2)

	}
	
	
});

// on socket shutdown
window.socket.addEventListener('close', function (event) {
var a = new Audio('suddendc.mp3');
a.play()
    console.log('Socket closed down.');
	document.getElementById('beforeconnect').style.display = 'block'
	document.getElementById('afterconnect').style.display = 'none'
	if (window.userinitiated == false) {
	document.getElementById('beforeconnect').innerHTML = '<p class="display">WebSocket connection failed<br>You are not in a call. JS provided error code: '+event.code
	} else {
		document.getElementById('beforeconnect').innerHTML = '<p class="display">WebSocket connection stopped by user<br>You are not in a call. JS provided error code: '+event.code
	}
	//alert("The connection to the ws:// server failed.")
});

window.socket.addEventListener('error', function (event) {
  console.log('WebSocket error: ', event);
  //document.getElementById('error').innerHTML = event;
});


}


function playSound(url) {
if (document.getElementById('deaf').checked == false) {
    var a = new Audio('data:audio/webm; codecs=opus;base64,'+url);
	a.volume = document.getElementById('vol').value;
    a.play();
	} else {
	console.log('this user is deafened')
	}
}


function transmitpacket() {
//start the stream
index = document.getElementById('aids').value;
navigator.mediaDevices.getUserMedia({ audio: {deviceId: window.aiid[index].deviceId} })
  .then(stream => {
    const mediaRecorder = new MediaRecorder(stream);
    mediaRecorder.start();
	var reader = new FileReader();
    const audioChunks = [];
    mediaRecorder.addEventListener('dataavailable', event => {
      audioChunks.push(event.data);
    });
	
//choose an event to stop the stream	
	//document.getElementById('txmsg').addEventListener('click', function() { mediaRecorder.stop() });
	setTimeout(function(){mediaRecorder.stop()}, document.getElementById('interval').value);

//what happens on stream stop
    mediaRecorder.addEventListener('stop', () => {
      console.log('finished, encoding...');
	  var aublob = new Blob(audioChunks, { 'type' : 'audio/webm; codecs=opus' })
	  var audurl = window.URL.createObjectURL(aublob);
	  console.log('blob URL: ' + audurl);
	  reader.readAsDataURL(aublob);
	  
	  reader.onload =  function(e){
        	console.log(e.target.result.replace('data:audio/webm; codecs=opus;base64,','').length);
			var burl =  e.target.result.replaceAll('+','+');
			burl = burl.replace('data:audio/webm; codecs=opus;base64,','')
			console.log(burl.slice(0,50) + '...' + burl.slice(-50))
			//here we have the audio data and we can do as we please with this
			
			//in this case we transmit it over the socket
			if (document.getElementById('mute').checked == false) {
			console.log('transmitting...')
			window.socket.send('RL'+getchannel()+burl);
			transmitpacket();
			} else {
			console.log('this user is muted')
			transmitpacket();
			}

}


}); //mediarecorder stop set 
}) //end navi.media...
} // close function

</script>
