import asyncio
import websockets
import ssl, pathlib # wss secure dependencies

connections = []
channels = {}

async def announce(wsobj, msg):
    global connections, channels
    channel = channels[wsobj]

    for i in connections:
        if channels[i] == channel: #if relevant channel matches that of the element
            await i.send(f'{msg}:{hex(id(wsobj))}')
    
async def echo(websocket):
    global connections
    global channels
    async for message in websocket:
        #print(websocket)
        try:
            cmd = message[0:2]
            channel = message[2:6]
            params = message[6:]
        except:
            cmd = 'NO'
            params = '<NULL>'

        if cmd == 'NO':
            pass # do nothing command
        if cmd == 'CN':
            await websocket.send(f'OK:added:{hex(id(websocket))}')
            connections.append(websocket)
            channels[websocket] = channel
            print(f'Added {websocket} to array with channel {channels[websocket]}.')
            #await announce(websocket, 'HELLO')
            #the handler should not transfer control away at any point or connection will close prematurely
        if cmd == 'DN':
            await connections[connections.index(websocket)].close()
            connections.remove(websocket)
            print(f'Dropped {websocket} at user request.')
            #await announce(websocket, 'BYE')
        else: #relay non commands
            for i in connections:
                if channels[i] == channel:
                    try: await i.send(message) # if the connobj channel is the current channel
                    except:
                        #await i.close()
                        connections.remove(i)
                        print(f'Dropped {websocket} due to unreachable host.')
                        #await announce(i, 'DIED')
                        pass

                   
                    #if unreachable, we try to close it then delete the obj. if that doesn't work then just delete the object

async def main():
    print('Starting ws server on port TCP:8080')

    ssl_context = ssl.SSLContext(ssl.PROTOCOL_TLS_SERVER)
    localhost_pem = pathlib.Path(__file__).with_name("certificate.pem")
    ssl_context.load_cert_chain(localhost_pem)

    
    async with websockets.serve(echo, "", 8080):
        await asyncio.Future()  # run forever

asyncio.run(main())
